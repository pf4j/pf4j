name: Release to Maven Central

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: 'Release version (e.g., 3.14.0)'
        required: true
        type: string
      developmentVersion:
        description: 'Next development version (e.g., 3.15.0-SNAPSHOT)'
        required: true
        type: string

concurrency:
  group: maven-central-release
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: maven
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_TOKEN
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Prepare release
        run: |
          mvn -B release:prepare \
            -DreleaseVersion=${{ github.event.inputs.releaseVersion }} \
            -DdevelopmentVersion=${{ github.event.inputs.developmentVersion }} \
            -Darguments="-DskipTests"
        env:
          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          MAVEN_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Perform release
        run: mvn -B release:perform -Darguments="-DskipTests"
        env:
          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          MAVEN_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ github.event.inputs.releaseVersion }}
          name: Release ${{ github.event.inputs.releaseVersion }}
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Summary
        if: success()
        run: |
          echo "## Release Complete! :tada:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released version:** ${{ github.event.inputs.releaseVersion }}" >> $GITHUB_STEP_SUMMARY
          echo "**Next development version:** ${{ github.event.inputs.developmentVersion }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release will be available on Maven Central within a few hours." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maven Coordinates:" >> $GITHUB_STEP_SUMMARY
          echo '```xml' >> $GITHUB_STEP_SUMMARY
          echo '<dependency>' >> $GITHUB_STEP_SUMMARY
          echo '  <groupId>org.pf4j</groupId>' >> $GITHUB_STEP_SUMMARY
          echo '  <artifactId>pf4j</artifactId>' >> $GITHUB_STEP_SUMMARY
          echo '  <version>${{ github.event.inputs.releaseVersion }}</version>' >> $GITHUB_STEP_SUMMARY
          echo '</dependency>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify on Maven Central:" >> $GITHUB_STEP_SUMMARY
          echo "https://central.sonatype.com/artifact/org.pf4j/pf4j/${{ github.event.inputs.releaseVersion }}" >> $GITHUB_STEP_SUMMARY
