name: Deploy Snapshot

on:
  workflow_dispatch:

jobs:
  snapshot:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: maven
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_TOKEN
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Clean Maven Cache
        run: mvn dependency:purge-local-repository

      - name: Verify snapshot version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version: $VERSION"
          if [[ ! $VERSION == *-SNAPSHOT ]]; then
            echo "::error::Not a SNAPSHOT version: $VERSION"
            exit 1
          fi

      - name: Deploy snapshot to Maven Central
        run: mvn -B clean deploy -Prelease
        env:
          MAVEN_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          MAVEN_TOKEN: ${{ secrets.SONATYPE_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Summary
        if: success()
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "## Snapshot Deployed! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Maven Usage:" >> $GITHUB_STEP_SUMMARY
          echo '```xml' >> $GITHUB_STEP_SUMMARY
          echo '<dependency>' >> $GITHUB_STEP_SUMMARY
          echo '  <groupId>org.pf4j</groupId>' >> $GITHUB_STEP_SUMMARY
          echo '  <artifactId>pf4j</artifactId>' >> $GITHUB_STEP_SUMMARY
          echo "  <version>$VERSION</version>" >> $GITHUB_STEP_SUMMARY
          echo '</dependency>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verify Deployment:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "mvn dependency:get -DgroupId=org.pf4j -DartifactId=pf4j -Dversion=$VERSION" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
